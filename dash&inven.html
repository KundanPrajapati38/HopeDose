<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard & Inventory - HopeDose</title>
  <!-- Authentication Check Script -->
  <script src="js/auth-check.js"></script>
  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <!-- Add AOS library for scroll animations -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <!-- Toastify for notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/product-management.css">
</head>

<body>

<!-- Include Header -->
<div id="header-placeholder"></div>

  <!-- Quick Navigation Tabs -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm" data-aos="fade-up" data-aos-delay="150">
        <div class="card-body">
          <h1 class="section-title" data-aos="fade-up">Product Analytics</h1>
          <ul class="nav nav-tabs justify-content-center" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-panel" type="button" role="tab" aria-controls="dashboard-panel" aria-selected="true">
                <i class="fas fa-chart-line me-2"></i>Dashboard
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-panel" type="button" role="tab" aria-controls="inventory-panel" aria-selected="false">
                <i class="fas fa-boxes me-2"></i>Inventory
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entry-panel" type="button" role="tab" aria-controls="entry-panel" aria-selected="false">
                <i class="fas fa-plus-circle me-2"></i>Add Products
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="productTabContent">
    <!-- Dashboard Tab Panel -->
    <div class="tab-pane fade show active" id="dashboard-panel" role="tabpanel" aria-labelledby="dashboard-tab">
      <!-- Expiring Products Alert -->
      <div class="row mb-4">
        <div class="col-12">
          <div id="expiring-products-alert" class="alert alert-warning d-none" role="alert">
            <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Products Expiring Soon!</h4>
            <p>The following products will expire within the next 10 days:</p>
            <ul id="expiring-products-list"></ul>
          </div>
        </div>
      </div>

      <!-- Dashboard Stats -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3" data-aos="fade-up">
          <div class="stats-card bg-primary text-white">
            <div class="stats-icon">
              <i class="fas fa-boxes"></i>
            </div>
            <div class="stats-info">
              <h3 id="total-products">0</h3>
              <p>Total Products</p>
            </div>
            <div class="stats-progress">
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3" data-aos="fade-up" data-aos-delay="100">
          <div class="stats-card bg-success text-white">
            <div class="stats-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stats-info">
              <h3 id="active-products">0</h3>
              <p>Active Products</p>
            </div>
            <div class="stats-progress">
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3" data-aos="fade-up" data-aos-delay="200">
          <div class="stats-card bg-warning text-dark">
            <div class="stats-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stats-info">
              <h3 id="expiring-soon">0</h3>
              <p>Expiring Soon</p>
            </div>
            <div class="stats-progress">
              <div class="progress">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 35%" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3" data-aos="fade-up" data-aos-delay="300">
          <div class="stats-card bg-danger text-white">
            <div class="stats-icon">
              <i class="fas fa-calendar-times"></i>
            </div>
            <div class="stats-info">
              <h3 id="expired-products">0</h3>
              <p>Expired Products</p>
            </div>
            <div class="stats-progress">
              <div class="progress">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 15%" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Distribution Chart -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3" data-aos="fade-up" data-aos-delay="400">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Category Distribution</h5>
            </div>
            <div class="card-body">
              <canvas id="categoryChart" height="250"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3" data-aos="fade-up" data-aos-delay="500">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Expiry Timeline</h5>
            </div>
            <div class="card-body">
              <canvas id="expiryChart" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row mb-4">
        <div class="col-12" data-aos="fade-up" data-aos-delay="600">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" id="add-product-btn">
                  <i class="fas fa-plus me-1"></i> Add Product
                </button>
                <button class="btn btn-success" id="export-csv">
                  <i class="fas fa-file-export me-1"></i> Export CSV
                </button>
                <button class="btn btn-info text-white" id="refresh-data">
                  <i class="fas fa-sync-alt me-1"></i> Refresh Data
                </button>
                <button class="btn btn-warning" id="show-expiring">
                  <i class="fas fa-exclamation-circle me-1"></i> View Expiring
                </button>
                <button class="btn btn-danger" id="manage-expired">
                  <i class="fas fa-trash-alt me-1"></i> Manage Expired
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Entries -->
      <div class="row mb-4">
        <div class="col-12" data-aos="fade-up" data-aos-delay="700">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0">Recent Entries</h5>
            </div>
            <div class="card-body">
              <div id="no-entries" class="text-center py-4">
                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                <p>No recent entries found</p>
              </div>
              <div id="recent-entries" class="recent-entries"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Table -->
      <div class="row">
        <div class="col-12" data-aos="fade-up" data-aos-delay="800">
          <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Product Inventory</h5>
              <div class="d-flex gap-2">
                <div class="input-group">
                  <input type="text" class="form-control" id="search-input" placeholder="Search products...">
                  <button class="btn btn-primary" type="button" id="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-filter"></i></span>
                  <select class="form-select form-select-sm" id="category-filter">
                    <option value="all">All Categories</option>
                    <option value="Toys">Toys</option>
                    <option value="Books">Books</option>
                    <option value="Clothes">Clothes</option>
                    <option value="Food">Food</option>
                    <option value="Games Kit">Games Kit</option>
                    <option value="Medicines">Medicines</option>
                    <option value="Others">Others</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table id="products-table" class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Product Name</th>
                      <th>Category</th>
                      <th>Quantity</th>
                      <th>Expiry Date</th>
                      <th>Days Remaining</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="products-table-body">
                    <!-- Table will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventory Tab Panel -->
    <div class="tab-pane fade" id="inventory-panel" role="tabpanel" aria-labelledby="inventory-tab">
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Inventory Management</h5>
              <div class="input-group" style="width: auto;">
                <input type="text" class="form-control" id="inventory-search" placeholder="Search products...">
                <button class="btn btn-primary" type="button" id="inventory-search-btn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon toys-icon">
                        <i class="fas fa-gamepad"></i>
                      </div>
                      <h5 class="mt-3">Toys</h5>
                      <p class="inventory-count" id="toys-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon books-icon">
                        <i class="fas fa-book"></i>
                      </div>
                      <h5 class="mt-3">Books</h5>
                      <p class="inventory-count" id="books-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon clothes-icon">
                        <i class="fas fa-tshirt"></i>
                      </div>
                      <h5 class="mt-3">Clothes</h5>
                      <p class="inventory-count" id="clothes-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon food-icon">
                        <i class="fas fa-utensils"></i>
                      </div>
                      <h5 class="mt-3">Food</h5>
                      <p class="inventory-count" id="food-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon games-icon">
                        <i class="fas fa-futbol"></i>
                      </div>
                      <h5 class="mt-3">Games Kit</h5>
                      <p class="inventory-count" id="games-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon medicines-icon">
                        <i class="fas fa-pills"></i>
                      </div>
                      <h5 class="mt-3">Medicines</h5>
                      <p class="inventory-count" id="medicines-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon others-icon">
                        <i class="fas fa-box-open"></i>
                      </div>
                      <h5 class="mt-3">Others</h5>
                      <p class="inventory-count" id="others-count">0 items</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-4">
                  <div class="card inventory-category-card add-category-card">
                    <div class="card-body text-center">
                      <div class="inventory-icon add-icon">
                        <i class="fas fa-plus"></i>
                      </div>
                      <h5 class="mt-3">Add Category</h5>
                      <p class="inventory-count">Create new</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Inventory List -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Inventory List</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="bulk-update">
                  <i class="fas fa-edit me-1"></i>Bulk Update
                </button>
                <button class="btn btn-sm btn-outline-success" id="export-inventory">
                  <i class="fas fa-file-export me-1"></i>Export
                </button>
                <button class="btn btn-sm btn-outline-info" id="print-inventory">
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table id="inventory-table" class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="select-all-items"></th>
                      <th>Product Name</th>
                      <th>Category</th>
                      <th>Quantity</th>
                      <th>Condition</th>
                      <th>Expiry Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="inventory-table-body">
                    <!-- Table will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Barcode Scanner -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0">Barcode Scanner</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="input-group">
                      <input type="text" class="form-control" id="barcode-input" placeholder="Enter barcode manually...">
                      <button class="btn btn-primary" type="button" id="search-barcode">
                        <i class="fas fa-search"></i> Search
                      </button>
                    </div>
                  </div>
                  <div class="mb-3">
                    <button id="start-scanner" class="btn btn-success me-2">
                      <i class="fas fa-camera"></i> Start Camera
                    </button>
                    <button id="stop-scanner" class="btn btn-danger" disabled>
                      <i class="fas fa-stop-circle"></i> Stop Scanner
                    </button>
                  </div>
                  <div class="scanner-container mb-3">
                    <div id="scanner-placeholder" class="scanner-placeholder text-center p-4 border rounded">
                      <i class="fas fa-barcode fa-3x mb-3 text-muted"></i>
                      <p>Click "Start Camera" to scan a barcode</p>
                    </div>
                    <div id="scanner-viewfinder" class="d-none">
                      <!-- Scanner will be initialized here -->
                    </div>
                    <div id="scanner-status" class="alert alert-info mt-2">Scanner inactive</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div id="scan-result" class="scan-result d-none">
                    <div class="card">
                      <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Product Found</h5>
                      </div>
                      <div class="card-body">
                        <h4 id="result-name" class="mb-2"></h4>
                        <p id="result-barcode" class="mb-2 text-muted"></p>
                        <div class="mb-3">
                          <span id="result-status" class="badge bg-success">Active</span>
                        </div>
                        <div class="row mb-3">
                          <div class="col-6">
                            <p class="mb-1"><strong>Category:</strong></p>
                            <p id="result-category"></p>
                          </div>
                          <div class="col-6">
                            <p class="mb-1"><strong>Quantity:</strong></p>
                            <p id="result-quantity"></p>
                          </div>
                        </div>
                        <div class="row mb-3">
                          <div class="col-6">
                            <p class="mb-1"><strong>Manufacture Date:</strong></p>
                            <p id="result-manufacture-date"></p>
                          </div>
                          <div class="col-6">
                            <p class="mb-1"><strong>Expiry Date:</strong></p>
                            <p id="result-expiry-date"></p>
                          </div>
                        </div>
                        <p class="mb-1"><strong>Description:</strong></p>
                        <p id="result-description" class="mb-3"></p>
                        <div class="d-flex gap-2">
                          <button id="edit-scanned-product" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button id="add-quantity" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Qty
                          </button>
                          <button id="remove-quantity" class="btn btn-warning">
                            <i class="fas fa-minus"></i> Remove Qty
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Entry Tab Panel (Simplified) -->
    <div class="tab-pane fade" id="entry-panel" role="tabpanel" aria-labelledby="entry-tab">
      <div class="row mb-4">
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            This is a simplified view. For full product management features, please go to the 
            <a href="product-management.html" class="alert-link">Product Management</a> page.
          </div>
        </div>
      </div>
      
      <!-- Product List -->
      <div class="row">
        <div class="col-12">
          <div class="custom-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3 class="mb-0">Product List</h3>
              <div class="d-flex gap-2">
                <select id="categoryFilter" class="form-select form-select-sm" style="width: auto;">
                  <option value="All">All Categories</option>
                  <option value="Toys">Toys</option>
                  <option value="Books">Books</option>
                  <option value="Clothes">Clothes</option>
                  <option value="Food">Food</option>
                  <option value="Games Kit">Games Kit</option>
                  <option value="Medicines">Medicines</option>
                  <option value="Others">Others</option>
                </select>
                <button id="saveProducts" class="btn btn-sm btn-outline-success">
                  <i class="fas fa-save me-1"></i>Save
                </button>
                <button id="clearProducts" class="btn btn-sm btn-outline-danger">
                  <i class="fas fa-trash-alt me-1"></i>Clear All
                </button>
              </div>
            </div>
            
            <div id="productList" class="product-list">
              <div class="no-products text-center py-5" id="noProductsMessage">
                <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
                <h4>No products added yet</h4>
                <p>Add your first product using the Product Management page</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Include Footer -->
<div id="footer-placeholder"></div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- AOS Animation Library -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<!-- QuaggaJS for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<!-- Toastify JS -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<!-- Custom JS -->
<script src="js/main.js"></script>
<script src="js/component-loader.js"></script>
<script src="js/product-management.js"></script>
<script src="js/dashboard.js"></script>

<script>
  // Initialize AOS
  AOS.init({
    duration: 800,
    easing: 'ease-in-out',
    once: true
  });

  // Load Header/footer component
  fetch('components/header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header-placeholder').innerHTML = data;
      // After loading header, update active link
      setTimeout(() => {
        document.querySelector('a[href="index.html"]').classList.remove('active');
      }, 100);
    });
  
  fetch('components/footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer-placeholder').innerHTML = data;
    });

  // Load product data from localStorage
  document.addEventListener('DOMContentLoaded', function() {
    // Load products from localStorage
    const products = JSON.parse(localStorage.getItem('products')) || [];
    
    // Update dashboard stats
    updateDashboardStats(products);
    
    // Populate product list
    populateProductList(products);
    
    // Initialize charts
    initializeCharts(products);
    
    // Check for expiring products
    checkExpiringProducts(products);
  });

  // Function to update dashboard stats
  function updateDashboardStats(products) {
    const totalProducts = products.length;
    const today = new Date();
    
    // Count active products (not expired)
    const activeProducts = products.filter(product => {
      if (product.noExpiry) return true;
      const expiryDate = new Date(product.expiryDate);
      return expiryDate > today;
    }).length;
    
    // Count expiring soon products (within 10 days)
    const expiringSoon = products.filter(product => {
      if (product.noExpiry) return false;
      const expiryDate = new Date(product.expiryDate);
      const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
      return daysRemaining > 0 && daysRemaining <= 10;
    }).length;
    
    // Count expired products
    const expiredProducts = products.filter(product => {
      if (product.noExpiry) return false;
      const expiryDate = new Date(product.expiryDate);
      return expiryDate <= today;
    }).length;
    
    // Update the DOM
    document.getElementById('total-products').textContent = totalProducts;
    document.getElementById('active-products').textContent = activeProducts;
    document.getElementById('expiring-soon').textContent = expiringSoon;
    document.getElementById('expired-products').textContent = expiredProducts;
  }

  // Function to initialize charts
  function initializeCharts(products) {
    // Category distribution chart
    const categories = {};
    products.forEach(product => {
      categories[product.category] = (categories[product.category] || 0) + 1;
    });
    
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(categories),
        datasets: [{
          data: Object.values(categories),
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#5a5c69', '#858796'
          ],
          hoverBackgroundColor: [
            '#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02d1b', '#484a52', '#6e707e'
          ],
          hoverBorderColor: "rgba(234, 236, 244, 1)",
        }]
      },
      options: {
        maintainAspectRatio: false,
        tooltips: {
          backgroundColor: "rgb(255,255,255)",
          bodyFontColor: "#858796",
          borderColor: '#dddfeb',
          borderWidth: 1,
          xPadding: 15,
          yPadding: 15,
          displayColors: false,
          caretPadding: 10,
        },
        legend: {
          display: true,
          position: 'bottom'
        },
        cutoutPercentage: 70,
      },
    });

    // Expiry timeline chart
    const today = new Date();
    const expiryGroups = {
      'Expired': 0,
      'Within 10 days': 0,
      'Within 30 days': 0,
      'Within 90 days': 0,
      'More than 90 days': 0,
      'No Expiry': 0
    };

    products.forEach(product => {
      if (product.noExpiry) {
        expiryGroups['No Expiry']++;
        return;
      }

      const expiryDate = new Date(product.expiryDate);
      const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

      if (daysRemaining <= 0) {
        expiryGroups['Expired']++;
      } else if (daysRemaining <= 10) {
        expiryGroups['Within 10 days']++;
      } else if (daysRemaining <= 30) {
        expiryGroups['Within 30 days']++;
      } else if (daysRemaining <= 90) {
        expiryGroups['Within 90 days']++;
      } else {
        expiryGroups['More than 90 days']++;
      }
    });

    const expiryCtx = document.getElementById('expiryChart').getContext('2d');
    new Chart(expiryCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(expiryGroups),
        datasets: [{
          label: 'Products',
          data: Object.values(expiryGroups),
          backgroundColor: [
            '#e74a3b', // Expired - red
            '#f6c23e', // Within 10 days - yellow
            '#4e73df', // Within 30 days - blue
            '#1cc88a', // Within 90 days - green
            '#36b9cc', // More than 90 days - cyan
            '#5a5c69'  // No Expiry - gray
          ],
          borderWidth: 1
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              precision: 0
            }
          }]
        }
      }
    });
  }

  // Function to check for expiring products
  function checkExpiringProducts(products) {
    const today = new Date();
    const expiringProducts = products.filter(product => {
      if (product.noExpiry) return false;
      const expiryDate = new Date(product.expiryDate);
      const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
      return daysRemaining > 0 && daysRemaining <= 10;
    });

    if (expiringProducts.length > 0) {
      const expiringList = document.getElementById('expiring-products-list');
      expiringList.innerHTML = '';
      
      expiringProducts.forEach(product => {
        const expiryDate = new Date(product.expiryDate);
        const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>${product.name}</strong> - Expires in ${daysRemaining} day${daysRemaining === 1 ? '' : 's'} (${product.expiryDate})`;
        expiringList.appendChild(li);
      });
      
      document.getElementById('expiring-products-alert').classList.remove('d-none');
    }
  }

  // Function to populate product list
  function populateProductList(products) {
    const productList = document.getElementById('productList');
    const noProductsMessage = document.getElementById('noProductsMessage');
    
    if (products.length === 0) {
      noProductsMessage.classList.remove('d-none');
      return;
    }
    
    noProductsMessage.classList.add('d-none');
    
    // Clear existing products
    const existingProducts = productList.querySelectorAll('.product-card');
    existingProducts.forEach(product => product.remove());
    
    // Populate products table
    const productsTableBody = document.getElementById('products-table-body');
    productsTableBody.innerHTML = '';
    
    const today = new Date();
    
    products.forEach((product, index) => {
      // Create table row
      const tr = document.createElement('tr');
      
      // Calculate days remaining
      let daysRemaining = '';
      let status = '';
      let statusClass = '';
      
      if (product.noExpiry) {
        daysRemaining = 'N/A';
        status = 'Active';
        statusClass = 'bg-success';
      } else {
        const expiryDate = new Date(product.expiryDate);
        const days = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        daysRemaining = days;
        
        if (days <= 0) {
          status = 'Expired';
          statusClass = 'bg-danger';
        } else if (days <= 10) {
          status = 'Expiring Soon';
          statusClass = 'bg-warning text-dark';
        } else {
          status = 'Active';
          statusClass = 'bg-success';
        }
      }
      
      tr.innerHTML = `
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td>${product.quantity || 1}</td>
        <td>${product.noExpiry ? 'No Expiry' : product.expiryDate}</td>
        <td>${daysRemaining}</td>
        <td><span class="badge ${statusClass}">${status}</span></td>
        <td>
          <button class="btn btn-sm btn-primary edit-product" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger delete-product" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      
      productsTableBody.appendChild(tr);
    });
    
    // Populate inventory table
    const inventoryTableBody = document.getElementById('inventory-table-body');
    if (inventoryTableBody) {
      inventoryTableBody.innerHTML = '';
      
      products.forEach((product, index) => {
        // Create table row
        const tr = document.createElement('tr');
        
        // Calculate status
        let status = '';
        let statusClass = '';
        
        if (product.noExpiry) {
          status = 'Active';
          statusClass = 'bg-success';
        } else {
          const expiryDate = new Date(product.expiryDate);
          const days = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
          
          if (days <= 0) {
            status = 'Expired';
            statusClass = 'bg-danger';
          } else if (days <= 10) {
            status = 'Expiring Soon';
            statusClass = 'bg-warning text-dark';
          } else {
            status = 'Active';
            statusClass = 'bg-success';
          }
        }
        
        tr.innerHTML = `
          <td><input type="checkbox" class="item-checkbox" data-index="${index}"></td>
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>${product.quantity || 1}</td>
          <td>${product.condition || 'Good'}</td>
          <td>${product.noExpiry ? 'No Expiry' : product.expiryDate}</td>
          <td><span class="badge ${statusClass}">${status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary edit-inventory-item" data-index="${index}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger delete-inventory-item" data-index="${index}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        inventoryTableBody.appendChild(tr);
      });
    }
    
    // Update category counts
    updateCategoryCounts(products);
    
    // Populate recent entries
    populateRecentEntries(products);
  }

  // Function to update category counts
  function updateCategoryCounts(products) {
    const categories = {
      'Toys': 0,
      'Books': 0,
      'Clothes': 0,
      'Food': 0,
      'Games Kit': 0,
      'Medicines': 0,
      'Others': 0
    };
    
    products.forEach(product => {
      if (categories.hasOwnProperty(product.category)) {
        categories[product.category]++;
      } else {
        categories['Others']++;
      }
    });
    
    // Update the DOM
    Object.keys(categories).forEach(category => {
      const countElement = document.getElementById(`${category.toLowerCase().replace(' ', '-')}-count`);
      if (countElement) {
        countElement.textContent = `${categories[category]} items`;
      }
    });
  }

  // Function to populate recent entries
  function populateRecentEntries(products) {
    const recentEntries = document.getElementById('recent-entries');
    const noEntries = document.getElementById('no-entries');
    
    if (products.length === 0) {
      noEntries.classList.remove('d-none');
      recentEntries.classList.add('d-none');
      return;
    }
    
    noEntries.classList.add('d-none');
    recentEntries.classList.remove('d-none');
    
    // Sort products by date added (assuming newest first)
    // In a real app, you'd have a dateAdded field
    const sortedProducts = [...products].reverse().slice(0, 5);
    
    recentEntries.innerHTML = '';
    
    sortedProducts.forEach(product => {
      const entryDiv = document.createElement('div');
      entryDiv.className = 'recent-entry p-3 border-bottom';
      
      entryDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">${product.name}</h6>
            <p class="text-muted mb-0">Category: ${product.category}</p>
          </div>
          <span class="badge bg-primary">${product.quantity || 1} items</span>
        </div>
      `;
      
      recentEntries.appendChild(entryDiv);
    });
  }

  // Event listeners for dashboard functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Add product button
    const addProductBtn = document.getElementById('add-product-btn');
    if (addProductBtn) {
      addProductBtn.addEventListener('click', function() {
        window.location.href = 'product-management.html';
      });
    }
    
    // Export CSV button
    const exportCsvBtn = document.getElementById('export-csv');
    if (exportCsvBtn) {
      exportCsvBtn.addEventListener('click', function() {
        exportProductsToCSV();
      });
    }
    
    // Refresh data button
    const refreshDataBtn = document.getElementById('refresh-data');
    if (refreshDataBtn) {
      refreshDataBtn.addEventListener('click', function() {
        const products = JSON.parse(localStorage.getItem('products')) || [];
        updateDashboardStats(products);
        populateProductList(products);
        initializeCharts(products);
        checkExpiringProducts(products);
        
        // Show success message
        Toastify({
          text: "Data refreshed successfully!",
          duration: 3000,
          close: true,
          gravity: "top",
          position: "right",
          backgroundColor: "#1cc88a",
        }).showToast();
      });
    }
    
    // Show expiring button
    const showExpiringBtn = document.getElementById('show-expiring');
    if (showExpiringBtn) {
      showExpiringBtn.addEventListener('click', function() {
        const expiringAlert = document.getElementById('expiring-products-alert');
        if (expiringAlert.classList.contains('d-none')) {
          // No expiring products
          Toastify({
            text: "No products expiring soon!",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#36b9cc",
          }).showToast();
        } else {
          // Scroll to expiring products alert
          expiringAlert.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }
    
    // Manage expired button
    const manageExpiredBtn = document.getElementById('manage-expired');
    if (manageExpiredBtn) {
      manageExpiredBtn.addEventListener('click', function() {
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const expiredProducts = products.filter(product => {
          if (product.noExpiry) return false;
          const expiryDate = new Date(product.expiryDate);
          return expiryDate <= new Date();
        });
        
        if (expiredProducts.length === 0) {
          Toastify({
            text: "No expired products found!",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#36b9cc",
          }).showToast();
          return;
        }
        
        // Filter to show only expired products
        document.getElementById('category-filter').value = 'all';
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        
        // Highlight expired products
        const tableRows = document.querySelectorAll('#products-table tbody tr');
        tableRows.forEach(row => {
          const statusCell = row.querySelector('td:nth-child(6)');
          if (statusCell && statusCell.textContent.trim() === 'Expired') {
            row.classList.add('table-danger');
            row.scrollIntoView({ behavior: 'smooth' });
          } else {
            row.classList.add('d-none');
          }
        });
        
        Toastify({
          text: `Showing ${expiredProducts.length} expired products`,
          duration: 3000,
          close: true,
          gravity: "top",
          position: "right",
          backgroundColor: "#e74a3b",
        }).showToast();
      });
    }

    // Initialize DataTables for better table functionality
    if ($.fn.DataTable) {
      $('#products-table').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 10,
        responsive: true
      });
      
      $('#inventory-table').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 10,
        responsive: true
      });
    }

    // Select all items checkbox
    const selectAllItems = document.getElementById('select-all-items');
    if (selectAllItems) {
      selectAllItems.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
    }

    // Barcode scanner functionality
    const startScanner = document.getElementById('start-scanner');
    const stopScanner = document.getElementById('stop-scanner');
    
    if (startScanner && stopScanner && typeof Quagga !== 'undefined') {
      startScanner.addEventListener('click', function() {
        initBarcodeScanner();
        this.disabled = true;
        stopScanner.disabled = false;
        document.getElementById('scanner-placeholder').classList.add('d-none');
        document.getElementById('scanner-viewfinder').classList.remove('d-none');
        document.getElementById('scanner-status').textContent = 'Scanner active - point camera at barcode';
      });
      
      stopScanner.addEventListener('click', function() {
        Quagga.stop();
        this.disabled = true;
        startScanner.disabled = false;
        document.getElementById('scanner-placeholder').classList.remove('d-none');
        document.getElementById('scanner-viewfinder').classList.add('d-none');
        document.getElementById('scanner-status').textContent = 'Scanner inactive';
      });
    }
  });

  // Function to export products to CSV
  function exportProductsToCSV() {
    const products = JSON.parse(localStorage.getItem('products')) || [];
    
    if (products.length === 0) {
      Toastify({
        text: "No products to export!",
        duration: 3000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: "#e74a3b",
      }).showToast();
      return;
    }
    
    // Create CSV content
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    csvContent += "Name,Category,Quantity,Manufacture Date,Expiry Date,Description\n";
    
    // Add product data
    products.forEach(product => {
      const expiryDate = product.noExpiry ? "No Expiry" : product.expiryDate;
      csvContent += `"${product.name}","${product.category}","${product.quantity || 1}","${product.manufactureDate}","${expiryDate}","${product.description}"\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "product_inventory.csv");
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
    
    Toastify({
      text: "CSV exported successfully!",
      duration: 3000,
      close: true,
      gravity: "top",
      position: "right",
      backgroundColor: "#1cc88a",
    }).showToast();
  }

  // Function to initialize barcode scanner
  function initBarcodeScanner() {
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#scanner-viewfinder'),
        constraints: {
          width: 480,
          height: 320,
          facingMode: "environment"
        },
      },
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader",
          "ean_8_reader",
          "code_39_reader",
          "code_39_vin_reader",
          "codabar_reader",
          "upc_reader",
          "upc_e_reader",
          "i2of5_reader"
        ],
        debug: {
          showCanvas: true,
          showPatches: true,
          showFoundPatches: true,
          showSkeleton: true,
          showLabels: true,
          showPatchLabels: true,
          showRemainingPatchLabels: true,
          boxFromPatches: {
            showTransformed: true,
            showTransformedBox: true,
            showBB: true
          }
        }
      },
    }, function(err) {
      if (err) {
        console.error(err);
        Toastify({
          text: "Error initializing scanner: " + err,
          duration: 3000,
          close: true,
          gravity: "top",
          position: "right",
          backgroundColor: "#e74a3b",
        }).showToast();
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(function(result) {
      const code = result.codeResult.code;
      document.getElementById('barcode-input').value = code;
      document.getElementById('scanner-status').textContent = `Detected barcode: ${code}`;
      
      // Search for product with this barcode
      searchProductByBarcode(code);
      
      // Stop scanner after successful detection
      Quagga.stop();
      document.getElementById('stop-scanner').disabled = true;
      document.getElementById('start-scanner').disabled = false;
      document.getElementById('scanner-placeholder').classList.remove('d-none');
      document.getElementById('scanner-viewfinder').classList.add('d-none');
    });
  }

  // Function to search product by barcode
  function searchProductByBarcode(barcode) {
    const products = JSON.parse(localStorage.getItem('products')) || [];
    
    // In a real app, products would have barcode property
    // For demo, we'll just use the first product
    if (products.length > 0) {
      const product = products[0];
      
      // Show result
      document.getElementById('scan-result').classList.remove('d-none');
      document.getElementById('result-name').textContent = product.name;
      document.getElementById('result-barcode').textContent = `Barcode: ${barcode}`;
      document.getElementById('result-category').textContent = product.category;
      document.getElementById('result-quantity').textContent = product.quantity || 1;
      document.getElementById('result-manufacture-date').textContent = product.manufactureDate;
      document.getElementById('result-expiry-date').textContent = product.noExpiry ? 'No Expiry' : product.expiryDate;
      document.getElementById('result-description').textContent = product.description || 'No description available';
      
      Toastify({
        text: "Product found!",
        duration: 3000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: "#1cc88a",
      }).showToast();
    } else {
      Toastify({
        text: "No product found with barcode: " + barcode,
        duration: 3000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: "#e74a3b",
      }).showToast();
    }
  }
</script>
</body>
</html>